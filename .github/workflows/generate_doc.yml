name: Generate Documentation

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'apis/**/*.h'
      - 'apis/**/*.json'
      - 'tools/md_generator/json/**/*.json'
  workflow_dispatch:
    inputs:
      regenerate_all:
        description: 'Regenerate documentation for all plugins'
        required: false
        type: boolean
        default: true

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonref
    
    - name: Get changed files
      id: changed_files
      if: github.event_name != 'workflow_dispatch'
      run: |
        # For PRs, compare against the base branch
        git fetch origin ${{ github.base_ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(h|json)$' | tr '\n' ' ')
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "Changed files: $CHANGED_FILES"
    
    - name: Validate JSON changes
      if: github.event_name != 'workflow_dispatch' && steps.changed_files.outputs.files != ''
      run: |
        cd tools/md_generator
        python3 generate_md_incremental.py --changed-files ${{ steps.changed_files.outputs.files }} --validate-only
        python3 update_sidebar.py
    
    - name: Generate documentation (incremental)
      if: github.event_name != 'workflow_dispatch' && steps.changed_files.outputs.files != ''
      run: |
        cd tools/md_generator
        python3 generate_md_incremental.py --changed-files ${{ steps.changed_files.outputs.files }}
    
    - name: Generate documentation (full)
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd tools/md_generator
        python3 generate_md.py
    
    - name: Check for documentation changes
      id: check_changes
      run: |
        git diff --exit-code docs/apis/ || echo "docs_changed=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push documentation changes to PR branch
      if: steps.check_changes.outputs.docs_changed == 'true' && github.event_name == 'pull_request'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/apis/
        git add docs/_sidebar.md
        git commit -m "chore: auto-generate documentation from interface changes"
        git push
    
    - name: Create topic branch and push documentation changes (manual)
      if: steps.check_changes.outputs.docs_changed == 'true' && github.event_name == 'workflow_dispatch'
      run: |
        # Create topic branch with date format: topic/doc-DDMMYY
        TOPIC_BRANCH="topic/doc-$(date +%d%m%y)"
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Create and checkout new topic branch
        git checkout -b "$TOPIC_BRANCH"
        
        # Add and commit changes
        git add docs/apis/
        git add docs/_sidebar.md
        git commit -m "chore: manually regenerate all documentation"
        
        # Push to topic branch
        git push origin "$TOPIC_BRANCH"
        
        echo "Documentation pushed to branch: $TOPIC_BRANCH"
    
    - name: Comment on PR with documentation preview
      if: github.event_name == 'pull_request' && steps.check_changes.outputs.docs_changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## Documentation Auto-Generated\n\nDocumentation has been automatically generated for the changed plugins and committed to this PR branch.\n\nThe generated documentation files have been added to the PR for review.'
          });
